{"version":3,"sources":["meteor://ðŸ’»app/packages/lookback:emails/lib/utils.js","meteor://ðŸ’»app/packages/lookback:emails/lib/template-helpers.js","meteor://ðŸ’»app/packages/lookback:emails/lib/routing.js","meteor://ðŸ’»app/packages/lookback:emails/lib/mailer.js"],"names":["fs","Npm","require","Path","htmlToText","isDevEnv","process","env","NODE_ENV","minorVersion","parseInt","Meteor","release","split","isModernMeteor","sass","ex","Package","TAG","developmentPrivateDir","reg","RegExp","sep","meteorRoot","cwd","replace","join","productionPrivateDir","realpathSync","privateDir","BUNDLE_PATH","ROOT","Utils","toText","html","opts","fromString","Logger","error","message","capitalizeFirstChar","string","charAt","toUpperCase","slice","setupLogger","logger","defaults","suppressInfo","_","extend","res","map","has","method","console","warn","compact","length","info","joinUrl","base","path","root","test","addStylesheets","template","juiceOpts","check","Match","ObjectIncluding","name","String","css","Optional","scss","content","readFile","juice","inlineContent","toCSS","addDoctype","relativePathFromApp","file","readFileSync","encoding","Error","packageToRecommend","renderSync","sourceMap","toString","line","column","TemplateHelpers","baseUrl","Mailer","settings","emailUrlFor","routeName","params","theRouter","Router","FlowRouter","call","hash","CONTENT_TYPES","text","arrayOrString","str","Array","isArray","Routing","render","compile","Object","route","routePrefix","Function","previewAction","type","OneOf","req","data","msg","exception","func","indexOf","writeHead","end","plainTextOpts","sendAction","query","to","testEmail","cc","bcc","options","subject","result","send","reallySentEmail","MAIL_URL","types","preview","each","action","Picker","silent","ROOT_URL","disabled","addRoutes","language","plainText","preserveMediaQueries","removeStyleTags","webResources","images","middlewares","use","middleware","isFunction","push","config","newSettings","factory","templates","helpers","layout","Boolean","blazeHelpers","Blaze","_globalHelpers","globalHelpers","addHelpers","Template","layoutContent","SSR","compileTemplate","tmpl","templateName","findWhere","rendered","__helpers","get","extraCSS","layoutData","body","sendEmail","sendOptions","replyTo","from","headers","attachments","omit","Email","init","forEach","precompile","obj"],"mappings":"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","file":"/packages/lookback_emails.js","sourcesContent":["// # Utils package for `lookback:emails`\n\nconst fs = Npm.require('fs');\nconst Path = Npm.require('path');\nconst htmlToText = Npm.require('html-to-text');\n\nconst isDevEnv = process.env.NODE_ENV === 'development';\nconst minorVersion = parseInt(Meteor.release.split('.')[1], 10);\n\nconst isModernMeteor = minorVersion >= 3;\n\n// since meteor 1.3 we no longer need meteor hacks just use the npm version\nconst sass = (function() {\n  if (isModernMeteor) {\n    try {\n      return require('node-sass');\n    } catch (ex) {} // eslint-disable-line no-empty\n  } else if (Package['chrisbutler:node-sass']) {\n    return Package['chrisbutler:node-sass'].sass;\n  }\n\n  return null;\n})();\n\nconst TAG = 'mailer-utils';\n\n// This package assumes that assets (templates, SCSS, CSS ..) are\n// stored in the `private` directory. Thanks to that, Meteor won't\n// touch the HTML and CSS, which are non-JS files.\n//\n// However, since the file paths are screwed up when bundling and\n// deploying Meteor apps, we need to set the BUNDLE_PATH env var\n// to keep track of where the bundle lives.\n//\n// When deployed, set the `BUNDLE_PATH` env var to the location, perhaps:\n//\n//     /var/www/app/bundle\n//\n// For Modulus, you need to use the `APP_DIR` variable, which you do NOT need to set.\n\nconst developmentPrivateDir = () => {\n  if (!isDevEnv) {\n    return '';\n  }\n\n  // In development, using `pwd` is fine. Remove the .meteor/foo/bar stuff though.\n  const reg = new RegExp(`${Path.sep}\\.meteor.*`, 'g');\n  const meteorRoot = process.cwd().replace(reg, '');\n  return Path.join(meteorRoot, 'private');\n};\n\nconst productionPrivateDir = () => {\n  if (isDevEnv) {\n    return '';\n  }\n\n  const meteorRoot = fs.realpathSync(`${process.cwd()}/../`);\n  return fs.realpathSync(`${meteorRoot}/../`);\n};\n\nconst privateDir = process.env.BUNDLE_PATH || productionPrivateDir();\n\nlet ROOT = privateDir && Path.join(privateDir, 'programs', 'server', 'assets', 'app');\n\nROOT = ROOT || developmentPrivateDir();\n\nUtils = {\n  // Takes an HTML string and outputs a text version of it. Catches and logs errors.\n  toText(html, opts = {}) {\n    try {\n      return htmlToText.fromString(html, opts);\n    } catch (ex) {\n      return Utils.Logger.error(`Could not make plain-text version from html: ${ex.message}`);\n    }\n  },\n\n  capitalizeFirstChar(string) {\n    return string.charAt(0).toUpperCase() + string.slice(1);\n  },\n\n  // Set up a logger to use through `Utils.Logger`. Verify\n  // that necessary methods exists on the injected `logger` and\n  // fallback if not.\n  setupLogger(logger, opts) {\n    const defaults = {\n      suppressInfo: false\n    };\n\n    opts = _.extend({}, defaults, opts);\n\n    const res = ['info', 'warn', 'error'].map(method => {\n      if (!_.has(logger, method)) {\n        console.warn(`The injected logger must support the ${method} method.`);\n        return false;\n      }\n      return true;\n    });\n\n    if (_.compact(res).length === 0) {\n      console.warn('Falling back to the native logger.');\n      this.Logger = console;\n    } else {\n      this.Logger = logger;\n    }\n\n    // Just do a noop for the `info` method\n    // if we're in silent mode.\n    if (opts.suppressInfo === true) {\n      this.Logger.info = function() {};\n    }\n  },\n\n  joinUrl(base, path) {\n    // Remove any trailing slashes and add front slash if not exist already.\n    const root = base.replace(/\\/$/, '');\n\n    if (!/^\\//.test(path)) {\n      path = `/${path}`;\n    }\n\n    return root + path;\n  },\n\n  addStylesheets(template, html, juiceOpts = {}) {\n    check(template, Match.ObjectIncluding({\n      name: String,\n      css: Match.Optional(String),\n      scss: Match.Optional(String)\n    }));\n\n    try {\n      let content = html;\n\n      if (template.css) {\n        const css = Utils.readFile(template.css);\n        content = juice.inlineContent(content, css, juiceOpts);\n      }\n\n      if (template.scss) {\n        const scss = Utils.toCSS(template.scss);\n        content = juice.inlineContent(content, scss, juiceOpts);\n      }\n\n      return content;\n\n    } catch (ex) {\n      Utils.Logger.error(`Could not add CSS to ${template.name}: ${ex.message}`, TAG);\n      return html;\n    }\n  },\n\n  addDoctype(html) {\n    return `<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\\n${html}`;\n  },\n\n  readFile(relativePathFromApp) {\n    const file = Path.join(ROOT, relativePathFromApp);\n\n    try {\n      return fs.readFileSync(file, {\n        encoding: 'utf8'\n      });\n    } catch (ex) {\n      throw new Meteor.Error(500, `Could not find file: ${file}`, ex.message);\n    }\n  },\n\n  // Take a path to a SCSS file and compiles it to CSS with `node-sass`.\n  toCSS(scss) {\n    if (!sass) {\n      const packageToRecommend = isModernMeteor\n        ? 'Please run `meteor npm install --save node-sass` in your app to add sass support.'\n        : 'Please run `meteor add chrisbutler:node-sass` to add sass support.';\n\n      Utils.Logger.warn(`Could not find sass module. Sass support is opt-in since lookback:emails@0.5.0.\n\n${packageToRecommend}`, TAG);\n      return Utils.readFile(scss);\n    }\n\n    const file = Path.join(ROOT, scss);\n\n    try {\n      return sass.renderSync({\n        file: file,\n        sourceMap: false\n      }).css.toString();\n    } catch (ex) {\n      console.error(`Sass failed to compile: ${ex.message}`);\n      console.error(`In ${ex.file || scss} at line ${ex.line}, column ${ex.column}`);\n      return '';\n    }\n  }\n};\n","// # Template helpers\n//\n// Built-in template helpers.\nTemplateHelpers = {\n  // `baseUrl` gives you a full absolute URL from a relative path.\n  //\n  //     {{ baseUrl '/some-path' }} => http://root-domain.com/some-path\n  baseUrl(path) {\n    return Utils.joinUrl(Mailer.settings.baseUrl, path);\n  },\n\n  // `emailUrlFor` takes an Iron Router route (with optional params) and\n  // creates an absolute URL.\n  //\n  //    {{ emailUrlFor 'myRoute' param='foo' }} => http://root-domain.com/my-route/foo\n  emailUrlFor(routeName, params) {\n    const theRouter = Package['iron:router'] ? Router : FlowRouter;\n\n    if (theRouter && theRouter.path) {\n      return Utils.joinUrl(Mailer.settings.baseUrl, theRouter.path.call(theRouter, routeName, params.hash));\n    }\n\n    Utils.Logger.warn(`We noticed that neither Iron Router nor FlowRouter is installed, thus 'emailUrlFor' can't render a path to the route '${routeName}.`);\n    return '//';\n  }\n};\n","// # Routes\n//\n// This package supports browser routes, so you can **preview**\n// and **send email designs** from the browser.\n\n// This function adds the `preview` route from a `template` object.\n// It will apply the returned data from a `data` function on the\n// provided `route` prop from the template.\n\nconst CONTENT_TYPES = {\n  html: 'text/html',\n  text: 'text/plain'\n};\n\nconst arrayOrString = (str) => {\n  return Array.isArray(str) ? str : str.split(',');\n};\n\nRouting = (template, settings, render, compile) => {\n  check(template, Object);\n  check(template.name, String);\n\n  if (template && !template.route) {\n    Utils.Logger.info(`Cannot set up route for '${template.name}' mailer template - missing 'route' propery. See documentation.`, 'mailer');\n    return;\n  }\n\n  check(template.route.path, String);\n  check(settings.routePrefix, String);\n  check(render, Function);\n  check(compile, Function);\n\n  const previewAction = (type) => {\n    check(type, Match.OneOf('html', 'text'));\n\n    return (req, res, params, _) => {\n      let data = null;\n\n      try {\n        data = template.route.data && template.route.data.call(res, params);\n      } catch (ex) {\n        let msg = '';\n        const exception = `Exception in ${template.name} data function: ${ex.message}`;\n\n        const func = template.route.data.toString();\n\n        if (func.indexOf('this.params') !== -1) {\n          msg = `Seems like you're calling this.params in the data function for the template '${template.name}'. As of 0.7.0, this package doesn't use Iron Router for server side routing, and thus you cannot rely on its API.\\n\\nYou can access URL params with the new function signature:\\n\\n\\tfunction data(params:object)\\n\\ninstead of using this.params. The function scope (this) is now an instance of NodeJS's http.ServerResponse.\\n\\nSee https://github.com/lookback/meteor-emails#version-history for more info.\\n\\nThe exception thrown was: ${ex.message}`;\n        } else if (func.indexOf('this.') !== -1 && Package['iron:router']) {\n          msg = `Seems like you're accessing 'this' in the data function for '${template.name}'. As of 0.7.0, we've removed Iron Router, and thus you cannot rely on its API.\\n\\nThe function scope is now an instance of NodeJS's http.ServerResponse.\\n\\nSee https://github.com/lookback/meteor-emails#version-history for more info.\\n\\nThe exception thrown was: ${ex.message}`;\n        } else {\n          msg = exception;\n        }\n\n        Utils.Logger.error(msg);\n        res.writeHead(500);\n        res.end(msg);\n      }\n\n      // Compile, since we wanna refresh markup and CSS inlining.\n      compile(template);\n\n      Utils.Logger.info(`Rendering ${template.name} as ${type}â€¦`);\n\n      let content = '';\n\n      try {\n        const html = render(template.name, data);\n        content = type === 'html' ? html : Utils.toText(html, settings.plainTextOpts);\n        Utils.Logger.info('Rendering successful!');\n      } catch (ex) {\n        const msg = `Could not preview email: ${ex.message}`;\n        Utils.Logger.error(msg);\n        content = msg;\n      }\n\n      res.writeHead(200, {\n        'Content-Type': CONTENT_TYPES[type]\n      });\n\n      return res.end(content, 'utf8');\n    };\n  };\n\n  const sendAction = (req, res, params, _) => {\n    const {to = settings.testEmail, cc, bcc} = params.query;\n\n    Utils.Logger.info(`Sending ${template.name}â€¦`);\n\n    if (to) {\n      let data = null;\n\n      try {\n        data = template.route.data && template.route.data.call(res, params);\n      } catch (ex) {\n        Utils.Logger.error(`Exception in ${template.name} data function: ${ex.message}`);\n        return;\n      }\n\n      const options = {\n        to: arrayOrString(to),\n        data,\n        template: template.name,\n        subject: `[TEST] ${template.name}`\n      };\n\n      if (cc) {\n        options.cc = arrayOrString(cc);\n      }\n\n      if (bcc) {\n        options.bcc = arrayOrString(bcc);\n      }\n\n      const result = Mailer.send(options);\n\n      let msg = '';\n\n      if (result === false) {\n        res.writeHead(500);\n        msg = 'Did not send test email, something went wrong. Check the logs.';\n      } else {\n        res.writeHead(200);\n        const reallySentEmail = !!process.env.MAIL_URL;\n        msg = reallySentEmail\n          ? `Sent test email to ${to}` + ((cc) ? ` and cc: ${cc}` : '') + ((bcc) ? `, and bcc: ${bcc}` : '')\n          : 'Sent email to STDOUT';\n      }\n\n      Utils.Logger.info(msg);\n      res.end(msg);\n\n    } else {\n      res.writeHead(400);\n      res.end('No testEmail or ?to parameter provided.');\n    }\n  };\n\n  const types = {\n    preview: previewAction('html'),\n    text: previewAction('text'),\n    send: sendAction\n  };\n\n  _.each(types, (action, type) => {\n    const path = `/${settings.routePrefix}/${type}${template.route.path}`;\n    const name = Utils.capitalizeFirstChar(template.name);\n    const routeName = String(type + name);\n\n    Utils.Logger.info(`Add route: [${routeName}] at path ${path}`);\n\n    Picker.route(path, (params, req, res) => action(req, res, params, template));\n  });\n};\n","// `lookback:emails` is a small package for Meteor which helps you\n// tremendously in the process of building, testing and debugging\n// HTML emails in Meteor applications.\n//\n// See the [GitHub repo](https://github.com/lookback/meteor-emails) for README.\n// Made by Johan Brook for [Lookback](https://github.com/lookback).\n\n\nconst TAG = 'mailer';\n\n// ## Setup\n\n// Main exported symbol with some initial settings:\n//\n// - `routePrefix` is the top level path for the preview and send routes (see further down).\n// - `baseUrl` is what root domain to base relative paths from.\n// - `testEmail`, when testing emails, set this variable.\n// - `logger`, optionally inject an external logger. Defaults to `console`.\n// - `disabled`, optionally disable the actual email sending. Useful for E2E testing.\n//    Defaults to `false`.\n// - `addRoutes`, should we add preview and send routes? Defaults to `true` in development.\nMailer = {\n  settings: {\n    silent: false,\n    routePrefix: 'emails',\n    baseUrl: process.env.ROOT_URL,\n    testEmail: null,\n    logger: console,\n    disabled: false,\n    addRoutes: process.env.NODE_ENV === 'development',\n    language: 'html',\n    plainText: true,\n    plainTextOpts: {},\n    juiceOpts: {\n      preserveMediaQueries: true,\n      removeStyleTags: true,\n      webResources: {\n        images: false\n      }\n    }\n  },\n\n  middlewares: [],\n\n  use(middleware) {\n    if (!_.isFunction(middleware)) {\n      console.error('Middleware must be a function!');\n    } else {\n      this.middlewares.push(middleware);\n    }\n\n    return this;\n  },\n\n  config(newSettings) {\n    this.settings = _.extend(this.settings, newSettings);\n    return this;\n  }\n};\n\n// # The factory\n//\n// This is the \"blueprint\" of the Mailer object. It has the following interface:\n//\n// - `precompile`\n// - `render`\n// - `send`\n//\n// As you can see, the mailer takes care of precompiling and rendering templates\n// with data, as well as sending emails from those templates.\nconst factory = (options) => {\n  check(options, Match.ObjectIncluding({\n    // Mailer *must* take a `templates` object with template names as keys.\n    templates: Object,\n    // Take optional template helpers.\n    helpers: Match.Optional(Object),\n    // Take an optional layout template object.\n    layout: Match.Optional(Match.OneOf(Object, Boolean))\n  }));\n\n  const settings = _.extend({}, Mailer.settings, options.settings);\n\n  const blazeHelpers = typeof Blaze !== 'undefined' ? Blaze._globalHelpers : {};\n  const globalHelpers = _.extend({}, TemplateHelpers, blazeHelpers, options.helpers);\n\n  Utils.setupLogger(settings.logger, {\n    suppressInfo: settings.silent\n  });\n\n  // Use the built-in helpers, any global Blaze helpers, and injected helpers\n  // from options, and *additional* template helpers, and apply them to\n  // the template.\n  const addHelpers = (template) => {\n    check(template.name, String);\n    check(template.helpers, Match.Optional(Object));\n    return Template[template.name].helpers(_.extend({}, globalHelpers, template.helpers));\n  };\n\n  // ## Compile\n  //\n  // Function for compiling a template with a name and path to\n  // a HTML file to a template function, to be placed\n  // in the Template namespace.\n  //\n  // A `template` must have a path to a template HTML file, and\n  // can optionally have paths to any SCSS and CSS stylesheets.\n  const compile = (template) => {\n    check(template, Match.ObjectIncluding({\n      path: String,\n      name: String,\n      scss: Match.Optional(String),\n      css: Match.Optional(String),\n      layout: Match.Optional(Match.OneOf(Boolean, {\n        name: String,\n        path: String,\n        scss: Match.Optional(String),\n        css: Match.Optional(String)\n      }))\n    }));\n\n    let content = null;\n\n    try {\n      content = Utils.readFile(template.path);\n    } catch (ex) {\n      Utils.Logger.error(`Could not read template file: ${template.path}`, TAG);\n      return false;\n    }\n\n    const layout = template.layout || options.layout;\n\n    if (layout && template.layout !== false) {\n      const layoutContent = Utils.readFile(layout.path);\n      SSR.compileTemplate(layout.name, layoutContent, {\n        language: settings.language\n      });\n\n      addHelpers(layout);\n    }\n\n    // This will place the template function in\n    //\n    //     Template.<template.name>\n    const tmpl = SSR.compileTemplate(template.name, content, {\n      language: settings.language\n    });\n\n    // Add helpers to template.\n    addHelpers(template);\n    return tmpl;\n  };\n\n  // ## Render\n  //\n  // Render a template by name, with optional data context.\n  // Will compile the template if not done already.\n  const render = (templateName, data) => {\n    check(templateName, String);\n    check(data, Match.Optional(Object));\n\n    const template = _.findWhere(options.templates, {\n      name: templateName\n    });\n\n    if (!(templateName in Template)) {\n      compile(template);\n    }\n\n    const tmpl = Template[templateName];\n\n    if (!tmpl) {\n      throw new Meteor.Error(500, `Could not find template: ${templateName}`);\n    }\n\n    let rendered = SSR.render(tmpl, data);\n    const layout = template.layout || options.layout;\n\n    if (layout && template.layout !== false) {\n      let preview = null;\n      let css = null;\n\n      // When applying to a layout, some info from the template\n      // (like the first preview lines) needs to be applied to the\n      // layout scope as well.\n      //\n      // Thus we fetch a `preview` helper from the template or\n      // `preview` prop in the data context to apply to the layout.\n      if (tmpl.__helpers.has('preview')) {\n        preview = tmpl.__helpers.get('preview');\n      } else if (data.preview) {\n        preview = data.preview;\n      }\n\n      // The `extraCSS` property on a `template` is applied to\n      // the layout in `<style>` tags. Ideal for media queries.\n      if (template.extraCSS) {\n        try {\n          css = Utils.readFile(template.extraCSS);\n        } catch (ex) {\n          Utils.Logger.error(\n            `Could not add extra CSS when rendering ${templateName}: ${ex.message}`, TAG);\n        }\n      }\n\n      const layoutData = _.extend({}, data, {\n        body: rendered,\n        css,\n        preview\n      });\n\n      rendered = SSR.render(layout.name, layoutData);\n      rendered = Utils.addStylesheets(template, rendered, settings.juiceOpts);\n      rendered = Utils.addStylesheets(layout, rendered, settings.juiceOpts);\n    } else {\n      rendered = Utils.addStylesheets(template, rendered, settings.juiceOpts);\n    }\n\n    rendered = Utils.addDoctype(rendered);\n    return rendered;\n  };\n\n  // ## Send\n  //\n  // The main sending-email function. Takes a set of usual email options,\n  // including the template name and optional data object.\n  const sendEmail = (sendOptions) => {\n    check(sendOptions, {\n      to: Match.OneOf(String, [String]),\n      subject: String,\n      template: String,\n      cc: Match.Optional(Match.OneOf(String, [String])),\n      bcc: Match.Optional(Match.OneOf(String, [String])),\n      replyTo: Match.Optional(Match.OneOf(String, [String])),\n      from: Match.Optional(String),\n      data: Match.Optional(Object),\n      headers: Match.Optional(Object),\n      attachments: Match.Optional([Object])\n    });\n\n    const defaults = {\n      from: settings.from\n    };\n\n    if (settings.replyTo) {\n      defaults.replyTo = settings.replyTo;\n    }\n\n    // `template` isn't part of Meteor's `Email.send()` API, so omit this.\n    const opts = _.omit(_.extend({}, defaults, sendOptions), 'template', 'data');\n\n    // Render HTML with optional data context and optionally\n    // create plain-text version from HTML.\n    try {\n      opts.html = render(sendOptions.template, sendOptions.data);\n      if (settings.plainText) {\n        opts.text = Utils.toText(opts.html, settings.plainTextOpts);\n      }\n    } catch (ex) {\n      Utils.Logger.error(`Could not render email before sending: ${ex.message}`, TAG);\n      return false;\n    }\n\n    try {\n      if (!settings.disabled) {\n        Email.send(opts);\n      }\n\n      return true;\n    } catch (ex) {\n      Utils.Logger.error(`Could not send email: ${ex.message}`, TAG);\n      return false;\n    }\n  };\n\n  const init = () => {\n    if (options.templates) {\n      _.each(options.templates, (template, name) => {\n        template.name = name;\n        compile(template);\n\n        Mailer.middlewares.forEach(func => {\n          func(template, settings, render, compile);\n        });\n      });\n    }\n  };\n\n  return {\n    precompile: compile,\n    render: render,\n    send: sendEmail,\n    init\n  };\n};\n\n// Init routine. We create a new \"instance\" from the factory.\n// Any middleware needs to be called upon before we run the\n// inner `init()` function.\nMailer.init = function(opts) {\n  const obj = _.extend(this, factory(opts));\n\n  if (obj.settings.addRoutes) {\n    obj.use(Routing);\n  }\n\n  obj.init();\n};\n"]}